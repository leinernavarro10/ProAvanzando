var neonChat=neonChat||{$current_user:null,isOpen:!1,chat_history:[],statuses:{online:{class:"is-online",order:1,label:"Online"},offline:{class:"is-offline",order:4,label:"Offline"},idle:{class:"is-idle",order:3,label:"Idle"},busy:{class:"is-busy",order:2,label:"Busy"}}};!function(e,s,t){"use strict";var a=e("#chat"),n=a.find(".chat-inner"),r=a.find(".badge").add(e(".chat-notifications-badge")),i=a.find(".chat-conversation"),o=i.find(".conversation-header"),h=i.find(".conversation-body"),d=i.find(".chat-textarea textarea"),u=!e(".page-container").hasClass("sidebar-collapsed");e.extend(neonChat,{init:function(){0==e.isFunction(e.fn.uniqueId)&&jQuery.fn.extend({uniqueId:function(){var e=0;return function(){return this.each(function(){this.id||(this.id="ui-id-"+ ++e)})}}()}),i.on("click",".conversation-close",neonChat.close),e("body").on("click",".chat-close",function(s){s.preventDefault();var t=e(this).is("[data-animate]");neonChat.hideChat(t)}),e("body").on("click",".chat-open",function(s){s.preventDefault();var t=e(this).is("[data-animate]");neonChat.showChat(t)}),d.keydown(function(e){if(13==e.keyCode&&!e.shiftKey)return e.preventDefault(),neonChat.submitMessage(),!1;27==e.keyCode&&neonChat.close()}),a.on("click",".chat-group a",function(s){s.preventDefault();var t=e(this);t.hasClass("active")?neonChat.close():neonChat.open(t)}),a.find(".chat-group a").each(function(s,t){e(t).append('<span class="badge badge-info is-hidden">0</span>')}),neonChat.refreshUserIds(),neonChat.orderGroups(),neonChat.prefetchMessages(),neonChat.countUnreadMessages(),neonChat.puffUnreads(),a.hasClass("fixed")&&n.length&&e.isFunction(e.fn.niceScroll)&&a.find(".chat-inner").niceScroll({cursorcolor:"#454a54",cursorborder:"1px solid #454a54",railpadding:{right:3},railalign:"right",cursorborderradius:1}),e("body").on("click",'[data-toggle="chat"]',function(s){s.preventDefault();var t=e(this),a=t.is("[data-animate]"),n=t.is("[data-collapse-sidebar]");neonChat.toggleChat(a,n)})},open:function(s){this.refreshUserIds(),"string"==typeof s&&(s=e(s)),a.find(".chat-group a").not(s).removeClass("active"),s.addClass("active");var t=this.statuses[this.chat_history[s.attr("id")].status];o.find(".display-name").html(s.find("em").text()),t&&(o.find(".user-status").attr("class","user-status "+t.class),o.find("small").html(t.label)),i.show(),d.val(""),this.updateScrollbars(),this.updateConversationOffset(s),d.focus(),this.$current_user=s,this.isOpen=!0,this.renderMessages(this.$current_user.attr("id")),this.resetUnreads(this.$current_user.attr("id")),this.puffUnreadsAll()},close:function(){return a.find(".chat-group a").removeClass("active"),i.hide().css({top:0,opacity:0}),h.find("li.unread").removeClass("unread"),this.$current_user=null,this.isOpen=!1,!1},updateScrollbars:function(){scrollToBottom("#chat .chat-conversation .conversation-body")},updateConversationOffset:function(t){var n=i.find(".conversation-body").position().top+1,r=t.position().top-n,o=0,h=i.height(),d=e(s).height();a.hasClass("fixed")&&r+h>d&&(o=r+h-d),e(".page-container.horizontal-menu").length&&(o+=e(".page-container.horizontal-menu .navbar").height()),r-=o,i.transition({top:r,opacity:1})},getChatHistoryLength:function(){var e=parseInt(a.data("max-chat-history"),10);return(!e||e<1)&&(e=25),e},submitMessage:function(){var s=e.trim(d.val());if(d.val(""),this.isOpen&&this.$current_user){var t=this.$current_user.uniqueId().attr("id");this.pushMessage(t,s.replace(/<.*?>/g,""),a.data("current-user"),new Date),this.renderMessages(t)}},refreshUserIds:function(){e("#chat .chat-group a").each(function(s,t){var a=e(t),n=a.find(".user-status");a.uniqueId();var r=a.attr("id");if(void 0===neonChat.chat_history[r]){var i=a.data("status");if(!i)for(var s in neonChat.statuses)if(n.hasClass(neonChat.statuses[s].class)){i=s;break}neonChat.chat_history[r]={$el:a,messages:[],unreads:0,status:i}}})},pushMessage:function(e,s,t,a,n,r){if(e&&s){this.refreshUserIds();var i=this.getChatHistoryLength();this.chat_history[e].messages.length>=i&&(this.chat_history[e].messages=this.chat_history[e].messages.reverse().slice(0,i-1).reverse()),this.chat_history[e].messages.push({message:s,from:t,time:a,fromOpponent:n,unread:r}),r&&this.puffUnreadsAll(),this.puffUnreads()}},renderMessages:function(s,t){if(void 0!==this.chat_history[s]){h.html("");for(var a in this.chat_history[s].messages){var n=this.chat_history[s].messages[a],r=e('<li><span class="user"></span><p></p><span class="time"></span></li>'),i=n.time,o=i;if("object"==typeof i){var d=((d=i.getHours())<10?"0":"")+d,u=((u=i.getMinutes())<10?"0":"")+u,c=i.getSeconds();c=(c<10?"0":"")+c,o=d+":"+u}r.find(".user").html(n.from),r.find("p").html(n.message.replace(/\n/g,"<br>")),r.find(".time").html(o),n.fromOpponent&&r.addClass("odd"),n.unread&&void 0===t&&(r.addClass("unread"),n.unread=!1),h.append(r)}this.updateScrollbars()}},getStatus:function(e){"object"==typeof e&&(e=e.attr("id"));var s=neonChat.chat_history[e];return s?s.status:null},setStatus:function(s,t){var a="string"==typeof s?e(".chat-group a#"+s.replace("#","")):s;if(a.$el&&(a=a.$el),a.length&&this.statuses[t].class){var n=a.find(".user-status");for(var r in this.statuses)n.removeClass(this.statuses[r].class);n.addClass(this.statuses[t].class),a.data("status",t),neonChat.chat_history[a.attr("id")].status=t,this.orderGroups()}},orderGroups:function(){var s=a.find(".chat-group");return!!a.data("order-by-status")&&(s.each(function(s,t){var a=e(t),n=a.find("> a");n.each(function(s,t){var a=e(t),n=a.find(".user-status");for(var s in neonChat.statuses){var r=neonChat.statuses[s];if(s==a.data("status"))return a.data("order-id",r.order),!0;if(n.hasClass(r.class))return a.data("order-id",r.order),!0}});n.sort(function(s,t){return parseInt(e(s).data("order-id"),10)>parseInt(e(t).data("order-id"),10)}).appendTo(a)}),!0)},prefetchMessages:function(){a.find(".chat-group a").each(function(s,t){var a=e(t),n=a.attr("id"),r=a.data("conversation-history");r&&r.length&&e(e(r)).find("> li").each(function(s,t){var a=e(t),r=a.find(".user").html(),i=a.find("p").html(),o=a.find(".time").html(),h=a.hasClass("even")||a.hasClass("odd")||a.hasClass("opponent"),d=a.hasClass("unread");neonChat.pushMessage(n,i,r,o,h,d)})})},countUnreadMessages:function(e){var s=0;if(e){if("object"==typeof e&&(e=e.attr("id")),t=neonChat.chat_history[e])return t.unreads}else for(var e in neonChat.chat_history){var t=neonChat.chat_history[e],a=0;for(var n in t.messages)t.messages[n].unread&&(s++,a++);t.unreads=a}return s},puffUnreads:function(){for(var e in this.chat_history){var s=neonChat.chat_history[e],t=s.$el.find(".badge");s.unreads>0?t.html(s.unreads).removeClass("is-hidden"):t.html(s.unreads).addClass("is-hidden")}},puffUnreadsAll:function(){var e=this.countUnreadMessages();r.html(e),r[e>0?"removeClass":"addClass"]("is-hidden")},resetUnreads:function(e){"object"==typeof e&&(e=e.attr("id"));var s=neonChat.chat_history[e];s&&(s.unreads=0,s.$el.find(".badge").html("0").addClass("is-hidden"))},createGroup:function(s,t){var n=e('<div class="chat-group"><strong>'+s+"</strong></div>");return t?n.insertBefore(a.find(".chat-group:first")):n.appendTo(a),n.hide().slideDown(),(n=n.uniqueId()).attr("id")},removeGroup:function(s,t){var n=a.find("#"+s.replace("#","")+".chat-group");if(n.length){if(t){var r=a.find("#"+t.replace("#","")+".chat-group");r.length&&n.find("a").each(function(s,t){var a=e(t);r.append(a),a.hide().slideDown()}),this.orderGroups()}n.slideUp(function(){n.remove()})}},addUser:function(s,t,n,r,i){var o=s;if("string"==typeof s&&(o=a.find("#"+s.replace("#","")+".chat-group")),o&&o.length){var n=this.statuses[n],h=e('<a href="#"><span class="user-status '+n.class+'"></span> <em>'+t+'</em> <span class="badge badge-info is-hidden>0</span></a>');return i&&h.attr("id",i),r?h.insertAfter(o.find("> strong")):h.appendTo(o),h.hide().slideDown(),this.refreshUserIds(),this.orderGroups(),h.uniqueId().attr("id")}return null},addUserId:function(e,s,t,a,n){return this.addUser(e,t,a,n,s)},getUser:function(e){return this.chat_history[e]?this.chat_history[e]:null},moveUser:function(e,s,t){var n=a.find("#"+s.replace("#","")+".chat-group"),r=this.chat_history[e];return!(!n.length||!r)&&(t?r.$el.insertAfter(n.find("> strong")):r.$el.appendTo(n),this.orderGroups(),!0)},showChat:function(e){var s="chat-visible";if(isxs()&&(s+=" toggle-click"),e){if(a.data("is-busy")||public_vars.$pageContainer.hasClass(s))return!1;a.data("is-busy",!0);var t=public_vars.$pageContainer.hasClass("right-sidebar")?-1:1;public_vars.$pageContainer.addClass(s),TweenMax.from(a,.3,{opacity:0,x:100*t,ease:Sine.easeInOut,onComplete:function(){a.data("is-busy",!1).removeAttr("style")}})}else public_vars.$pageContainer.addClass(s)},hideChat:function(e){var s="chat-visible";if(isxs()&&(s+=" toggle-click"),e){if(a.data("is-busy")||0==public_vars.$pageContainer.hasClass(s))return!1;a.data("is-busy",!0);var t=public_vars.$pageContainer.hasClass("right-sidebar")?-1:1;TweenMax.to(a,.3,{opacity:0,x:100*t,ease:Sine.easeInOut,onComplete:function(){a.data("is-busy",!1).removeAttr("style"),public_vars.$pageContainer.removeClass(s)}})}else public_vars.$pageContainer.removeClass(s)},toggleChat:function(e,s){var t=public_vars.$pageContainer.hasClass("chat-visible")?"hideChat":"showChat";isxs()&&(t=public_vars.$pageContainer.hasClass("toggle-click")?"hideChat":"showChat"),neonChat[t](e),s&&u&&("hideChat"==t?show_sidebar_menu(e):hide_sidebar_menu(e))}}),h.on("click",function(){d.focus()}),neonChat.init()}(jQuery,window);