!function(){"use strict";function e(e,t,n){var o=e.docs[t];o?n(N(e,o)):e.options.getFile?e.options.getFile(t,n):n(null)}function t(e,t,n){for(var o in e.docs){var r=e.docs[o];if(r.doc==t)return r}if(!n)for(var i=0;;++i)if(o="[doc"+(i||"")+"]",!e.docs[o]){n=o;break}return e.addDoc(n,t)}function n(e,n,r){var i=t(e,n),s=e.cachedArgHints;s&&s.doc==n&&C(s.start,r.to)<=0&&(e.cachedArgHints=null);var a=i.changed;null==a&&(i.changed=a={from:r.from.line,to:r.from.line});var c=r.from.line+(r.text.length-1);r.from.line<a.to&&(a.to=a.to-(r.to.line-c)),c>=a.to&&(a.to=c+1),a.from>r.from.line&&(a.from=r.from.line),n.lineCount()>q&&r.to-a.from>100&&setTimeout(function(){i.changed&&i.changed.to-i.changed.from>100&&o(e,i)},200)}function o(e,t){e.server.request({files:[{type:"full",name:t.name,text:N(e,t)}]},function(e){e?console.error(e):t.changed=null})}function r(e,t,n){e.request(t,{type:"completions",types:!0,docs:!0,urls:!0},function(o,r){if(o)return k(e,t,o);var s=[],a="",c=r.start,l=r.end;'["'==t.getRange(H(c.line,c.ch-2),c)&&'"]'!=t.getRange(l,H(l.line,l.ch+2))&&(a='"]');for(var u=0;u<r.completions.length;++u){var d=r.completions[u],f=i(d.type);r.guess&&(f+=" "+S+"guess"),s.push({text:d.name+a,displayText:d.name,className:f,data:d})}var p={from:c,to:l,list:s},h=null;CodeMirror.on(p,"close",function(){w(h)}),CodeMirror.on(p,"update",function(){w(h)}),CodeMirror.on(p,"select",function(t,n){w(h);var o=e.options.completionTip?e.options.completionTip(t.data):t.data.doc;o&&((h=b(n.parentNode.getBoundingClientRect().right+window.pageXOffset,n.getBoundingClientRect().top+window.pageYOffset,o)).className+=" "+S+"hint-doc")}),n(p)})}function i(e){var t;return t="?"==e?"unknown":"number"==e||"string"==e||"bool"==e?e:/^fn\(/.test(e)?"fn":/^\[/.test(e)?"array":"object",S+"completion "+S+"completion-"+t}function s(e,t,n){e.request(t,"type",function(n,o){if(n)return k(e,t,n);if(e.options.typeTip)r=e.options.typeTip(o);else{var r=x("span",null,x("strong",null,o.type||"not found"));o.doc&&r.appendChild(document.createTextNode(" — "+o.doc)),o.url&&(r.appendChild(document.createTextNode(" ")),r.appendChild(x("a",null,"[docs]")).href=o.url)}T(t,r)},n)}function a(e,t){if(D(e),!t.somethingSelected()){var n=t.getTokenAt(t.getCursor()).state,o=CodeMirror.innerMode(t.getMode(),n);if("javascript"==o.mode.name){var r=o.state.lexical;if("call"==r.info){for(var i,s=r.pos||0,a=t.getOption("tabSize"),u=t.getCursor().line,d=Math.max(0,u-9),f=!1;u>=d;--u){for(var p=t.getLine(u),h=0,g=0;;){var m=p.indexOf("\t",g);if(-1==m)break;h+=a-(m+h)%a-1,g=m+1}if(i=r.column-h,"("==p.charAt(i)){f=!0;break}}if(f){var v=H(u,i),y=e.cachedArgHints;if(y&&y.doc==t.getDoc()&&0==C(v,y.start))return c(e,t,s);e.request(t,{type:"type",preferFunction:!0,end:v},function(n,o){!n&&o.type&&/^fn\(/.test(o.type)&&(e.cachedArgHints={start:g,type:l(o.type),name:o.exprName||o.name||"fn",guess:o.guess,doc:t.getDoc()},c(e,t,s))})}}}}}function c(e,t,n){D(e);for(var o=e.cachedArgHints,r=o.type,i=x("span",o.guess?S+"fhint-guess":null,x("span",S+"fname",o.name),"("),s=0;s<r.args.length;++s){s&&i.appendChild(document.createTextNode(", "));var a=r.args[s];i.appendChild(x("span",S+"farg"+(s==n?" "+S+"farg-current":""),a.name||"?")),"?"!=a.type&&(i.appendChild(document.createTextNode(": ")),i.appendChild(x("span",S+"type",a.type)))}i.appendChild(document.createTextNode(r.rettype?") -> ":")")),r.rettype&&i.appendChild(x("span",S+"type",r.rettype));var c=t.cursorCoords(null,"page");e.activeArgHints=b(c.right+1,c.bottom,i)}function l(e){var t=[],n=3;if(")"!=e.charAt(n))for(;;){var o=e.slice(n).match(/^([^, \(\[\{]+): /);if(o&&(n+=o[0].length,o=o[1]),t.push({name:o,type:function(t){for(var o=0,r=n;;){var i=e.charAt(n);if(t.test(i)&&!o)return e.slice(r,n);/[{\[\(]/.test(i)?++o:/[}\]\)]/.test(i)&&--o,++n}}(/[\),]/)}),")"==e.charAt(n))break;n+=2}var r=e.slice(n).match(/^\) -> (.*)$/);return{args:t,rettype:r&&r[1]}}function u(e,n){function o(o){var r={type:"definition",variable:o||null},i=t(e,n.getDoc());e.server.request(v(e,i,r),function(t,o){if(t)return k(e,n,t);if(!o.file&&o.url)return void window.open(o.url);if(o.file){var r,s=e.docs[o.file];if(s&&(r=p(s.doc,o)))return e.jumpStack.push({file:i.name,start:n.getCursor("from"),end:n.getCursor("to")}),void f(e,i,s,r.start,r.end)}k(e,n,"Could not find a definition.")})}h(n)?o():M(n,"Jump to variable",function(e){e&&o(e)})}function d(e,n){var o=e.jumpStack.pop(),r=o&&e.docs[o.file];r&&f(e,t(e,n.getDoc()),r,o.start,o.end)}function f(e,t,n,o,r){n.doc.setSelection(r,o),t!=n&&e.options.switchToDoc&&(D(e),e.options.switchToDoc(n.name))}function p(e,t){for(var n=t.context.slice(0,t.contextOffset).split("\n"),o=t.start.line-(n.length-1),r=H(o,(1==n.length?t.start.ch:e.getLine(o).length)-n[0].length),i=e.getLine(o).slice(r.ch),s=o+1;s<e.lineCount()&&i.length<t.context.length;++s)i+="\n"+e.getLine(s);if(i.slice(0,t.context.length)==t.context)return t;for(var a,c=e.getSearchCursor(t.context,0,!1),l=1/0;c.findNext();){var u=c.from(),d=1e4*Math.abs(u.line-r.line);d||(d=Math.abs(u.ch-r.ch)),d<l&&(a=u,l=d)}if(!a)return null;if(1==n.length?a.ch+=n[0].length:a=H(a.line+(n.length-1),n[n.length-1].length),t.start.line==t.end.line)f=H(a.line,a.ch+(t.end.ch-t.start.ch));else var f=H(a.line+(t.end.line-t.start.line),t.end.ch);return{start:a,end:f}}function h(e){var t=e.getCursor("end"),n=e.getTokenAt(t);return(!(n.start<t.ch)||"comment"!=n.type&&"string"!=n.type)&&/\w/.test(e.getLine(t.line).slice(Math.max(t.ch-1,0),t.ch+1))}function g(e,t){var n=t.getTokenAt(t.getCursor());/\w/.test(n.string)||k(e,t,"Not at a variable"),M(t,"New name for "+n.string,function(n){e.request(t,{type:"rename",newName:n,fullDocs:!0},function(n,o){if(n)return k(e,t,n);m(e,o.changes)})})}function m(e,t){for(var n=Object.create(null),o=0;o<t.length;++o)(n[(c=t[o]).file]||(n[c.file]=[])).push(c);for(var r in n){var i=e.docs[r],s=n[r];if(i){s.sort(function(e,t){return C(t.start,e.start)});for(var a="*rename"+ ++L,o=0;o<s.length;++o){var c=s[o];i.doc.replaceRange(c.text,c.start,c.end,a)}}}}function v(e,t,n,o){var r=[],i=0,s=!n.fullDocs;s||delete n.fullDocs,"string"==typeof n&&(n={type:n}),n.lineCharPositions=!0,null==n.end&&(n.end=o||t.doc.getCursor("end"),t.doc.somethingSelected()&&(n.start=t.doc.getCursor("start")));var a=n.start||n.end;if(t.changed)if(t.doc.lineCount()>q&&!1!==s&&t.changed.to-t.changed.from<100&&t.changed.from<=a.line&&t.changed.to>n.end.line){r.push(y(t,a,n.end)),n.file="#0";i=r[0].offsetLines;null!=n.start&&(n.start=H(n.start.line- -i,n.start.ch)),n.end=H(n.end.line-i,n.end.ch)}else r.push({type:"full",name:t.name,text:N(e,t)}),n.file=t.name,t.changed=null;else n.file=t.name;for(var c in e.docs){var l=e.docs[c];l.changed&&l!=t&&(r.push({type:"full",name:l.name,text:N(e,l)}),l.changed=null)}return{query:n,files:r}}function y(e,t,n){for(var o,r=e.doc,i=null,s=null,a=t.line-1,c=Math.max(0,a-50);a>=c;--a){var l=r.getLine(a);if(!(l.search(/\bfunction\b/)<0)){var u=CodeMirror.countColumn(l,null,4);null!=i&&i<=u||(i=u,s=a)}}null==s&&(s=c);var d=Math.min(r.lastLine(),n.line+20);if(null==i||i==CodeMirror.countColumn(r.getLine(t.line),null,4))o=d;else for(o=n.line+1;o<d&&!((u=CodeMirror.countColumn(r.getLine(o),null,4))<=i);++o);var f=H(s,0);return{type:"part",name:e.name,offsetLines:f.line,text:r.getRange(f,H(o,0))}}function C(e,t){return e.line-t.line||e.ch-t.ch}function x(e,t){var n=document.createElement(e);t&&(n.className=t);for(var o=2;o<arguments.length;++o){var r=arguments[o];"string"==typeof r&&(r=document.createTextNode(r)),n.appendChild(r)}return n}function M(e,t,n){e.openDialog?e.openDialog(t+": <input type=text>",n):n(prompt(t,""))}function T(e,t){function n(){r.parentNode&&(e.off("cursorActivity",n),A(r))}var o=e.cursorCoords(),r=b(o.right+1,o.bottom,t);setTimeout(n,1700),e.on("cursorActivity",n)}function b(e,t,n){var o=x("div",S+"tooltip",n);return o.style.left=e+"px",o.style.top=t+"px",document.body.appendChild(o),o}function w(e){var t=e&&e.parentNode;t&&t.removeChild(e)}function A(e){e.style.opacity="0",setTimeout(function(){w(e)},1100)}function k(e,t,n){e.options.showError?e.options.showError(t,n):T(t,String(n))}function D(e){e.activeArgHints&&(w(e.activeArgHints),e.activeArgHints=null)}function N(e,t){var n=t.doc.getValue();return e.options.fileFilter&&(n=e.options.fileFilter(n,t.name,t.doc)),n}function F(t){function n(e,t){t&&(e.id=++r,i[r]=t),o.postMessage(e)}var o=new Worker(t.options.workerScript);o.postMessage({type:"init",defs:t.options.defs,plugins:t.options.plugins,scripts:t.options.workerDeps});var r=0,i={};o.onmessage=function(o){var r=o.data;"getFile"==r.type?e(t,r.name,function(e,t){n({type:"getFile",err:String(e),text:t,id:r.id})}):"debug"==r.type?console.log(r.message):r.id&&i[r.id]&&(i[r.id](r.err,r.body),delete i[r.id])},o.onerror=function(e){for(var t in i)i[t](e);i={}},this.addFile=function(e,t){n({type:"add",name:e,text:t})},this.delFile=function(e){n({type:"del",name:e})},this.request=function(e,t){n({type:"req",body:e},t)}}CodeMirror.TernServer=function(t){var o=this;this.options=t||{};var r=this.options.plugins||(this.options.plugins={});r.doc_comment||(r.doc_comment=!0),this.options.useWorker?this.server=new F(this):this.server=new tern.Server({getFile:function(t,n){return e(o,t,n)},async:!0,defs:this.options.defs||[],plugins:r}),this.docs=Object.create(null),this.trackChange=function(e,t){n(o,e,t)},this.cachedArgHints=null,this.activeArgHints=null,this.jumpStack=[]},CodeMirror.TernServer.prototype={addDoc:function(e,t){var n={doc:t,name:e,changed:null};return this.server.addFile(e,N(this,n)),CodeMirror.on(t,"change",this.trackChange),this.docs[e]=n},delDoc:function(e){var t=this.docs[e];t&&(CodeMirror.off(t.doc,"change",this.trackChange),delete this.docs[e],this.server.delFile(e))},hideDoc:function(e){D(this);var t=this.docs[e];t&&t.changed&&o(this,t)},complete:function(e){var t=this;CodeMirror.showHint(e,function(e,n){return r(t,e,n)},{async:!0})},getHint:function(e,t){return r(this,e,t)},showType:function(e,t){s(this,e,t)},updateArgHints:function(e){a(this,e)},jumpToDef:function(e){u(this,e)},jumpBack:function(e){d(this,e)},rename:function(e){g(this,e)},request:function(e,n,o,r){var i=this,s=t(this,e.getDoc()),a=v(this,s,n,r);this.server.request(a,function(e,t){!e&&i.options.responseFilter&&(t=i.options.responseFilter(s,n,a,e,t)),o(e,t)})}};var H=CodeMirror.Pos,S="CodeMirror-Tern-",q=250,L=0}();